#!/bin/sh
#
# https://github.com/mitchweaver/bin
#
# set display brightness on M1 machines with Asahi
# tested working on 2021 14" Macbook Pro
#

die() {
    >&2 echo "$*"
    usage
}

warn() {
    >&2 echo "$*"
}

usage() {
    >&2 printf 'Usage: %s 1-255\n' "${0##*/}"
    exit 1
}

isnum() {
    case $1 in
        ''|*[!0-9]*)
            return 1
            ;;
        *)
            return 0
    esac
}

clamp() {
    if [ "$1" -gt 255 ] ; then
        warn "arg \"$1\" > 255; clamping"
        echo 255
    elif [ "$1" -lt 1 ] ; then
        warn "arg \"$1\" < 1; clamping"
        echo 1
    else
        echo "$1"
    fi
}

isnum "$1" || die "not a number"

val=$(clamp "$1")

if [ -e /sys/class/backlight/apple-panel-bl/brightness ] ; then
    echo "$val" | sudo tee /sys/class/backlight/apple-panel-bl/brightness
else
    die "Error: /sys/class/backlight/apple-panel-bl/brightness doesn't seem to exist"
fi
