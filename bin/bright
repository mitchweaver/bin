#!/bin/sh
#
# http://github.com/mitchweaver/bin
#
# brightness wrapper
# supports xbacklight/acpilight on Linux and backlight on FreeBSD
#

usage() {
    >&2 printf '%s\n' "Usage: ${0##*/} [-i] [-d] [-s value]"
    exit 1
}

set_br() {
    case $(uname) in
        FreeBSD)
            backlight "$(clamp "$1")"
            ;;
        Linux)
            xbacklight -set "$(clamp "$1")"
    esac
}

isnumber() {
    for i ; do
        case $i in
            ''|*[!0-9]*)
                return 1
        esac
    done
}

clamp() {
    isnumber "$1" || usage

    case $1 in
        100*)
            echo 100
            ;;
        0|-*)
            echo 1
            ;;
        *)
            printf '%s\n' "$1"
    esac
}

get() {
    case $(uname) in
        FreeBSD)
            br=$(backlight -q)
            ;;
        Linux)
            br=$(xbacklight -get)
    esac
    printf '%s\n' "${br%.*}"
}

main() {
    case ${1#-} in
        h)
            usage
            ;;
        i)
            set_br $(( $(get) + ${2:-${BRIGHT_INCREMENT:-7}} ))
            ;;
        d)
            set_br $(( $(get) - ${2:-${BRIGHT_INCREMENT:-7}} ))
            ;;
        s)
            if [ "$2" ] ; then
                set_br "$2"
            else
                usage
            fi
            ;;
        *)
            printf '%s%%\n' "$(get)"
    esac
}

main "$@"
